apiVersion: platform.plural.sh/v1alpha1
kind: Dashboard
metadata:
  name: {{ template "cluster-operator.fullname" $ }}-rabbit
  labels:
{{ include "cluster-operator.labels" . | indent 4 }}
spec:
  name: rabbitmq
  description: telemetry for forge's rabbitmq cluster
  timeslices: [30m, 1h, 2h, 1d]
  defaultTime: 30m
  labels:
  - name: kubernetes_pod_name
    query:
      query: rabbitmq_consumers{app_kubernetes_io_instance="{{ .Release.Name }}"}
      label: kubernetes_pod_name
  graphs:
  - queries:
    - query: sum(rabbitmq_connections{app_kubernetes_io_instance="{{ .Release.Name }}"})
      legend: connections
    - query: sum(rabbitmq_channels{app_kubernetes_io_instance="{{ .Release.Name }}"})
      legend: channels
    - query: sum(rabbitmq_consumers{app_kubernetes_io_instance="{{ .Release.Name }}"})
      legend: consumers
    format: none
    name: Connection details
  - queries:
    - query: sum(rabbitmq_queue_messages{app_kubernetes_io_instance="{{ .Release.Name }}"})
      legend: messages
    format: none
    name: Messages
  - queries:
    - query: min(rabbitmq_disk_space_available_bytes{kubernetes_pod_name=~"$kubernetes_pod_name"})
      legend: disk free
    - query: min(rabbitmq_disk_space_available_limit_bytes{kubernetes_pod_name=~"$kubernetes_pod_name"})
      legend: memory used
    format: bytes
    name: Disk utilization
  - queries:
    - query: sum(rabbitmq_queue_process_memory_bytes{kubernetes_pod_name=~"$kubernetes_pod_name"}) by (kubernetes_pod_name)
      legend: process memory
    - query: sum(rabbitmq_messages_bytes{kubernetes_pod_name=~"$kubernetes_pod_name"}) by (kubernetes_pod_name)
      legend: message memory
    format: bytes
    name: Memory Utilization